# Applied Fixes: Data Races and Concurrency Issues

> This file documents fixes already applied to the codebase.
> For roadmap items, see the bottom section.

## Summary

| File | Change | Status |
|------|--------|--------|
| `internal/ui/model.go` | Add `agentState` struct with mutex | ✅ Applied |
| `internal/ui/model.go` | Change `MainModel.agent` to `*agentState` | ✅ Applied |
| `internal/ui/model.go` | Change `err` to `atomic.Value` | ✅ Applied |
| `internal/ui/model.go` | Add `getErr()` / `setErr()` methods | ✅ Applied |
| `internal/ui/model.go` | Update `InitialModel()` to init agent | ✅ Applied |
| `internal/ui/update.go` | Use `agent.isRunning()` / `getChannel()` | ✅ Applied |
| `internal/ui/update.go` | Use `agent.tryStart()` in startAgent | ✅ Applied |
| `internal/ui/update.go` | Use `agent.stop()` on completion | ✅ Applied |
| `internal/ui/update.go` | Remove select from startAgent Cmd | ✅ Applied |
| `pkg/utils/simplelogger.go` | Handle WriteString/Sync/Close errors | ✅ Applied |
| `pkg/tools/registry.go` | Allow `def.Parameters == nil` | ✅ Applied |

## Problems Fixed

### Problem 1: Unsafe access to agentResultCh and agentRunning
Fields accessed from multiple goroutines without mutex protection.

**Solution**: `agentState` struct with `sync.Mutex` accessed via pointer.

### Problem 2: Double channel read
Two `select` statements competing for same channel (in Update() and startAgent Cmd).

**Solution**: Channel reading ONLY in Update(), Cmd just sends AgentTickMsg.

### Problem 3: Unprotected err field
`err` field read from View() without synchronization.

**Solution**: Changed to `atomic.Value` with `getErr()`/`setErr()` methods.

### Problem 4: CRITICAL - Mutex copying in Bubble Tea
Bubble Tea uses value receiver: `func (m MainModel) Update(...)`. Adding mutex directly would copy it.

**Solution**: `agentState` stored as `*agentState` pointer in MainModel.

### Problem 5: Rule 7 - Ignored errors in simplelogger
`WriteString/Sync/Close` errors were ignored.

**Solution**: Added error handling with fallback to stderr.

### Problem 6: Rule 8 - validateToolDefinition too strict
Required ALL tools to have `parameters.type == "object"`.

**Solution**: Allow `def.Parameters == nil` for parameterless tools.

## Architecture Note: Why agentState is separate

```go
// Bubble Tea copies the model on every Update:
func (m MainModel) Update(msg tea.Msg) (tea.Model, tea.Cmd)
//    ^^^^^^^^^^ VALUE - m is a copy!

// WRONG: Mutex in MainModel gets copied
type MainModel struct {
    mu sync.Mutex  // ❌ Copied on every Update()
}

// CORRECT: Mutex in separate struct accessed via pointer
type agentState struct {
    mu sync.Mutex  // ✅ Not copied - pointer stays same
}

type MainModel struct {
    agent *agentState  // ✅ Pointer value doesn't change
}
```

When Update() returns new MainModel, the `agent` pointer is copied but still points to the **same** agentState instance.

## Testing

```bash
# Verify no data races
go test -race ./internal/ui/...
go run -race cmd/poncho/main.go
```

Expected: No data race warnings.

---

## Roadmap (NOT YET IMPLEMENTED)

### Problem: llm.Provider `tools ...any` is not type-safe

**Current:**
```go
type Provider interface {
    Generate(ctx context.Context, messages []Message, tools ...any) (Message, error)
}
```

**Issues:**
1. Magic type - unclear what `tools` expects
2. Runtime type checking required (`openai/client.go:96-99`)
3. Cannot easily add new configurations

**Proposed (BREAKING CHANGE for v2.0.0):**
```go
type ToolsConfig struct {
    Definitions []ToolDefinition
    Mode        string  // "auto", "required", "none"
}

type Provider interface {
    Generate(ctx context.Context, messages []Message, toolsConfig *ToolsConfig) (Message, error)
}
```

**Status**: Deferred. Current implementation works correctly.

### Problem: Rule 9 - Mockability

**Missing interfaces:**
- `s3storage.Client` → no interface for mocking
- `wb.Client` → no interface for mocking

**Status**: Deferred. Not critical for production, testable via integration tests.

---

## Benefits

1. **No Mutex Copying**: agentState with pointer prevents Go violation in Bubble Tea
2. **Thread Safety**: Explicit mutex and atomic protection prevents race conditions
3. **Single Responsibility**: Channel reading only in Update(), ticking only in Cmd
4. **Duplicate Prevention**: Cannot start multiple agents simultaneously
5. **Encapsulated Operations**: agentState methods hide mutex complexity
6. **Clear Intent**: Synchronization requirements are explicit in code
7. **Rule Compliance**: Follows Rules 5, 7, 8 from dev_manifest.md
