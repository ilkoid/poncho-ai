# Models Configuration
models:
  default_reasoning: "glm-4.6"  # Reasoning модель для orchestrator (планирование, tool selection)
  default_chat: "glm-4.6"       # Chat модель (fallback, используется в post-prompts)
  default_vision: "glm-4.6v-flash" # Vision модель для анализа изображений
  definitions:
    glm-4.6:
      provider: "zai"
      model_name: "glm-4.6"
      api_key: "${ZAI_API_KEY}"
      base_url: "https://api.z.ai/api/paas/v4"
      max_tokens: 2000
      temperature: 0.5
      timeout: "120s"
      thinking: "enabled"
      parallel_tool_calls: false
      is_vision: false
    glm-4.6v-flash:
      provider: "zai"
      model_name: "glm-4.6v-flash"
      api_key: "${ZAI_API_KEY}"
      base_url: "https://api.z.ai/api/paas/v4"
      max_tokens: 4000
      temperature: 0.1
      timeout: "120s"
      parallel_tool_calls: false
      is_vision: true

# S3 Configuration
s3:
  endpoint: "storage.yandexcloud.net"
  region: "ru-central1"
  bucket: "plm-ai"
  access_key: "${S3_ACCESS_KEY}"
  secret_key: "${S3_SECRET_KEY}"
  use_ssl: true

# Image Settings
image_processing:
  max_width: 800
  quality: 90

# App Settings
app:
  debug: true
  prompts_dir: "./prompts"

  # Streaming Configuration
  streaming:
    enabled: true        # Default: true (opt-out). Streaming включен по умолчанию
    thinking_only: true  # Default: true. Отправлять только reasoning_content события

  # Debug Logs Configuration (JSON трейсы выполнения)
  debug_logs:
    enabled: true           # Включить запись отладочных логов
    save_logs: true         # Сохранять логи в файлы
    logs_dir: "./debug_logs" # Директория для логов
    include_tool_args: true  # Включать аргументы инструментов
    include_tool_results: true # Включать результаты инструментов
    max_result_size: 5000   # Максимальный размер результата (символов)

# Классификация файлов в бакете
file_rules:
  - tag: "sketch"
    patterns:
      - "*.jpg"
      - "*.jpeg"
      - "*.png"
    required: true

  - tag: "plm_data"
    patterns:
      - "*.json"
    required: true

  - tag: "marketing"
    patterns:
      - "*seo*"
      - "*keys*"

# Wildberries API (используется для дефолтных значений)
wb:
  api_key: "${WB_API_KEY}"
  base_url: "https://content-api.wildberries.ru"  # Default для всех WB tools
  rate_limit: 100      # Default: запросов в минуту
  burst_limit: 5       # Default: burst capacity
  retry_attempts: 3    # Default: retry attempts
  timeout: "30s"       # Default: HTTP timeout

# Tool Bundles Configuration
#
# Bundles позволяют группировать инструменты по бизнес-контексту для токен-оптимизации.
# Вместо 100 инструментов в system prompt (~15,000 токенов) можно отправить 10 bundles (~300 токенов).
#
# Гибридный режим: bundles + individual overrides
# 1. Сначала включаются инструменты из enable_bundles
# 2. Затем применяются individual overrides из tools секции
#
# Пример использования:
#   enable_bundles:
#     - wb-content-tools
#     - s3-tools
#   tools:
#     get_wb_feedbacks: {enabled: false}  # Выключаем конкретный tool из bundle

tool_bundles:
  # === Wildberries Content API ===
  wb-content-tools:
    description: "Wildberries Content API: поиск товаров, категории, бренды, характеристики, ТНВЭД"
    tools:
      - search_wb_products
      - get_wb_parent_categories
      - get_wb_subjects
      - get_wb_subjects_by_name
      - get_wb_characteristics
      - get_wb_tnved
      - get_wb_brands
      - ping_wb_api
      - reload_wb_dictionaries

  # === Wildberries Feedbacks API ===
  wb-feedbacks-tools:
    description: "Wildberries Feedbacks API: отзывы, вопросы, уведомления, статистика"
    tools:
      - get_wb_feedbacks
      - get_wb_questions
      - get_wb_new_feedbacks_questions
      - get_wb_unanswered_feedbacks_counts
      - get_wb_unanswered_questions_counts

  # === Wildberries Analytics API ===
  wb-analytics-tools:
    description: "Wildberries Analytics API: воронки продаж, позиции в поиске, рекламные кампании, ключевые слова"
    tools:
      - get_wb_product_funnel
      - get_wb_product_funnel_history
      - get_wb_search_positions
      - get_wb_top_search_queries
      - get_wb_top_organic_positions
      - get_wb_campaign_stats
      - get_wb_keyword_stats
      - get_wb_attribution_summary

  # === Wildberries Dictionaries ===
  wb-dictionaries-tools:
    description: "Справочники Wildberries: цвета, страны, пол, сезоны, НДС"
    tools:
      - wb_colors
      - wb_countries
      - wb_genders
      - wb_seasons
      - wb_vat_rates

  # === S3 Storage Tools ===
  s3-storage-tools:
    description: "S3 хранилище: список файлов, чтение объектов, загрузка изображений"
    tools:
      - list_s3_files
      - read_s3_object
      - read_s3_image
      - get_plm_data

  # === S3 Batch Tools ===
  s3-batch-tools:
    description: "Пакетные операции S3: классификация файлов, анализ изображений"
    tools:
      - classify_and_download_s3_files
      - analyze_article_images_batch

  # === Planner Tools ===
  planner-tools:
    description: "Планировщик задач: добавление, выполнение, провал задач"
    tools:
      - plan_add_task
      - plan_mark_done
      - plan_mark_failed
      - plan_clear
      - plan_set_tasks

# Какие bundles включить (опционально)
# Если не указано, используются individual enabled флаги из tools секции
enable_bundles: []

# Tools Configuration
#
# Каждый tool имеет свою конфигурацию с параметрами:
#   - enabled: включён ли tool
#   - description: описание для LLM (function calling)
#   - endpoint: базовый URL API (если применимо)
#   - path: путь к endpoint (если применимо)
#   - rate_limit: запросов в минуту (если применимо)
#   - burst: burst capacity (если применимо)
#   - default_take: дефолтное количество записей (для feedbacks)
#   - post_prompt: путь к post-prompt файлу (опционально)
#
# Гибридный режим:
# - Сначала инструменты включаются из bundles (если enable_bundles не пуст)
# - Затем individual overrides из этой секции могут переопределить состояние
#
# Если tool не указан в этом списке или enabled=false, он не регистрируется.

tools:
  # === WB Content API Tools ===
  search_wb_products:
    enabled: false
    description: "Ищет товары Wildberries по артикулам поставщика (vendor code/supplier article) и возвращает их nmID. Использует Content API (категория Promotion). ВАЖНО: видит только товары продавца, которому принадлежит API токен (до 100 карточек). Для поиска товаров других продавцов используйте get_wb_feedbacks или get_wb_questions."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5
    post_prompt: "agent_system.yaml"

  get_wb_parent_categories:
    enabled: false
    description: "Возвращает список родительских категорий Wildberries (например: Женщинам, Электроника). Используй это, чтобы найти ID категории."
    endpoint: "https://content-api.wildberries.ru"
    path: "/content/v2/object/parent/all"
    rate_limit: 100
    burst: 5
    timeout: "30s"
    post_prompt: "parent_categories_analysis.yaml"

  get_wb_subjects:
    enabled: false
    description: "Возвращает список предметов (подкатегорий) для заданной родительской категории с пагинацией."
    endpoint: "https://content-api.wildberries.ru"
    path: "/content/v2/object/all"
    rate_limit: 100
    burst: 5
    post_prompt: "subjects_analysis.yaml"

  get_wb_subjects_by_name:
    enabled: false
    description: "Ищет предметы (подкатегории) Wildberries по подстроке в названии. Возвращает список подходящих предметов с их ID и родительскими категориями."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5

  get_wb_characteristics:
    enabled: false
    description: "Возвращает список характеристик для указанного предмета (subjectID). Включает информацию о том, является ли характеристика обязательной, тип данных, единицы измерения."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5

  get_wb_tnved:
    enabled: false
    description: "Возвращает список кодов ТНВЭД для указанного предмета. Коды ТНВЭД нужны для создания карточки товара и маркировки Честный ЗНАК (isKiz=true)."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5

  get_wb_brands:
    enabled: false
    description: "Возвращает список брендов для указанного предмета. Бренды отсортированы по популярности. Используй это для выбора бренда при создании карточки товара."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5
    default_take: 500

  ping_wb_api:
    enabled: false
    description: "Проверяет доступность Wildberries Content API. Возвращает статус сервиса, timestamp и информацию об ошибках (например, неверный API ключ, недоступность сети). Используй для диагностики перед другими операциями с WB."
    endpoint: "https://content-api.wildberries.ru"
    path: "/ping"
    rate_limit: 100
    burst: 5
    post_prompt: "api_health_report.yaml"

  # === WB Feedbacks API Tools (новые) ===
  get_wb_feedbacks:
    enabled: false
    description: "Возвращает отзывы на товары Wildberries с пагинацией. Позволяет фильтровать по отвеченности (isAnswered: true/false) и артикулу (nmID)."
    endpoint: "https://feedbacks-api.wildberries.ru"
    path: "/api/v1/feedbacks"
    rate_limit: 60    # 1 req/sec
    burst: 3
    default_take: 100
    post_prompt: "agent_system.yaml"

  get_wb_questions:
    enabled: false
    description: "Возвращает вопросы о товарах Wildberries с пагинацией. Позволяет фильтровать по отвеченности (isAnswered: true/false) и артикулу (nmID)."
    endpoint: "https://feedbacks-api.wildberries.ru"
    path: "/api/v1/questions"
    rate_limit: 60
    burst: 3
    default_take: 100
    post_prompt: "agent_system.yaml"

  get_wb_new_feedbacks_questions:
    enabled: false
    description: "Проверяет наличие новых отзывов и вопросов на Wildberries. Возвращает количество непрочитанных отзывов и вопросов."
    endpoint: "https://feedbacks-api.wildberries.ru"
    path: "/api/v1/new-feedbacks-questions"
    rate_limit: 60
    burst: 3
    post_prompt: "agent_system.yaml"

  get_wb_unanswered_feedbacks_counts:
    enabled: false
    description: "Возвращает количество неотвеченных отзывов на Wildberries (общее и за сегодня). Используй для мониторинга качества сервиса."
    endpoint: "https://feedbacks-api.wildberries.ru"
    rate_limit: 60
    burst: 3
    post_prompt: "agent_system.yaml"

  get_wb_unanswered_questions_counts:
    enabled: false
    description: "Возвращает количество неотвеченных вопросов на Wildberries (общее и за сегодня). Используй для мониторинга качества сервиса."
    endpoint: "https://feedbacks-api.wildberries.ru"
    rate_limit: 60
    burst: 3
    post_prompt: "agent_system.yaml"

  # === WB Dictionary Tools ===
  wb_colors:
    enabled: false
    description: "Ищет цвета в справочнике Wildberries по подстроке. Возвращает топ-N подходящих цветов с названиями и базовыми цветами (parentName). Используй для точного определения цвета товара из описания или анализа изображения."
    post_prompt: "agent_system.yaml"

  wb_countries:
    enabled: false
    description: "Возвращает справочник стран производства для Wildberries. Используй для выбора страны происхождения товара при создании карточки."
    post_prompt: "agent_system.yaml"

  wb_genders:
    enabled: false
    description: "Возвращает справочник значений пола (gender/kind) для Wildberries. Используй для выбора пола товара при создании карточки."
    post_prompt: "agent_system.yaml"

  wb_seasons:
    enabled: false
    description: "Возвращает справочник сезонов для Wildberries. Используй для выбора сезона товара при создании карточки."
    post_prompt: "agent_system.yaml"

  wb_vat_rates:
    enabled: false
    description: "Возвращает справочник ставок НДС (VAT) для Wildberries. Используй для выбора ставки НДС товара при создании карточки."
    post_prompt: "agent_system.yaml"

  # === WB Service Tools ===
  reload_wb_dictionaries:
    enabled: false
    description: "Перезагружает справочники Wildberries из API. Возвращает количество записей в каждом справочнике. Используй для проверки доступности API или после изменения данных. ВНИМАНИЕ: не обновляет состояние агента, только возвращает данные."
    endpoint: "https://content-api.wildberries.ru"
    rate_limit: 100
    burst: 5
    post_prompt: "agent_system.yaml"

  # === S3 Basic Tools ===
  list_s3_files:
    enabled: false
    description: "Возвращает список файлов в S3 хранилище по указанному пути (префиксу). Используй это, чтобы найти артикулов или проверить наличие файлов."

  read_s3_object:
    enabled: true
    description: "Читает содержимое файла из S3. Поддерживает текстовые файлы (JSON, TXT, MD). Не используй для картинок."

  read_s3_image:
    enabled: true
    description: "Скачивает изображение из S3, оптимизирует его (resize) и возвращает в формате Base64. Используй это для Vision-анализа."

  get_plm_data:
    enabled: true
    description: "Загружает PLM данные (plm.json) артикула из S3 и возвращает очищенный JSON без технических полей, миниатюр и эскизов. Используй для получения информации о товаре: артикул, категория, сезон, цвета, материалы, размерный ряд."

  # === Planner Tools ===
  plan_add_task:
    enabled: false
    description: "Добавляет новую задачу в план действий. Указывай четкое описание того, что нужно выполнить."

  plan_mark_done:
    enabled: false
    description: "Отмечает задачу как выполненную. Используй когда задача успешно завершена."

  plan_mark_failed:
    enabled: false
    description: "Отмечает задачу как проваленную с указанием причины. Используй когда задачу невозможно выполнить по независимым причинам."

  plan_clear:
    enabled: false
    description: "Очищает весь план действий. Используй для удаления всех задач из списка."

  plan_set_tasks:
    enabled: false
    description: "Создает или заменяет весь план задач за один вызов. Используй это когда нужно составить полный план действий с нуля или полностью пересмотреть существующий план. LLM видит текущий план через контекст и учитывает его при перезаписи."

  # === S3 Batch Tools ===
  classify_and_download_s3_files:
    enabled: true
    description: "Списывает и классифицирует файлы артикула из S3 по тегам (sketch, plm_data, marketing). JSON файлы скачивает сразу, изображения — только метаданные. Для vision-анализа используй read_s3_image."
    post_prompt: "articles/product_description.yaml"

  analyze_article_images_batch:
    enabled: false
    description: "Анализирует изображения из текущего артикула с помощью Vision LLM. Обрабатывает картинки параллельно в горутинах. Опционально фильтрует по тегу (sketch, plm_data, marketing). Используй это после classify_and_download_s3_files для анализа эскизов."

  # === WB Analytics Tools ===
  get_wb_product_funnel:
    enabled: true
    description: "Воронка продаж по товарам за период (просмотры→корзина→заказ, конверсии)"
    endpoint: "https://seller-analytics-api.wildberries.ru"
    rate_limit: 180  # 3 req/min (лимит WB Analytics API)
    burst: 3

  get_wb_product_funnel_history:
    enabled: true
    description: "История воронки по дням (до 7 дней бесплатно, до 365 с Джем)"
    endpoint: "https://seller-analytics-api.wildberries.ru"
    rate_limit: 180
    burst: 3

  get_wb_search_positions:
    enabled: true
    description: "Позиции товаров в поиске и видимость (средняя позиция, топ-100)"
    endpoint: "https://seller-analytics-api.wildberries.ru"
    rate_limit: 180
    burst: 3

  get_wb_top_search_queries:
    enabled: true
    description: "Топ поисковых запросов по товару (до 100 фраз, сортировка по заказам)"
    endpoint: "https://seller-analytics-api.wildberries.ru"
    rate_limit: 180
    burst: 3

  get_wb_top_organic_positions:
    enabled: true
    description: "Топ-10 позиций в органическом поиске по запросам (агрегирует данные из get_wb_top_search_queries)"
    endpoint: "https://seller-analytics-api.wildberries.ru"
    rate_limit: 180
    burst: 3

  get_wb_campaign_stats:
    enabled: true
    description: "Статистика рекламных кампаний (показы, клики, CTR, CPC, затраты, заказы)"
    endpoint: "https://advert-api.wildberries.ru"
    rate_limit: 60   # 1 req/min (строгий лимит Promotion API)
    burst: 1

  get_wb_keyword_stats:
    enabled: true
    description: "Статистика по ключевым фразам кампании (за 7 дней, максимум)"
    endpoint: "https://advert-api.wildberries.ru"
    rate_limit: 240  # 4 req/sec (для keyword stats)
    burst: 4

  get_wb_attribution_summary:
    enabled: true
    description: "Атрибуция заказов: органика vs реклама по товару (агрегирует данные из воронки и кампаний)"

# Chain Configuration (Chain Pattern)
# Rule 2: Конфигурация цепочек через YAML
chains:
  default:
    type: "react"
    description: "Стандартная ReAct цепочка для общих запросов"
    system_prompt: "You are a helpful AI assistant with access to tools."
    model: "glm-4.6"
    temperature: 0.5
    max_tokens: 2000
    max_iterations: 10
    timeout: "5m"
    prompts_dir: "./prompts"
    interruption_prompt: "interruption_handler.yaml"  # Interruption handler промпт
    debug:
      enabled: false
      save_logs: true
      logs_dir: "./logs"
      include_tool_args: true
      include_tool_results: true
      max_result_size: 5000
    tool_post_prompts:
      get_wb_parent_categories: "wb/parent_categories_analysis.yaml"
      get_wb_subjects: "wb/subjects_analysis.yaml"
      ping_wb_api: "wb/api_health_report.yaml"
