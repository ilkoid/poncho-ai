# План рефакторинга: Перенос TUI из `/internal` в `/pkg/tui`

## Контекст

**Замысел проекта:** Создать полезную для Go-сообщества библиотеку для разработки AI-агентов, связанных с e-commerce. При этом **лёгкое использование TUI должно быть частью замысла**.

**Проблема текущей архитектуры:**
- TUI-компоненты находятся в `internal/ui/` — это скрывает их от внешних пользователей
- Go-разработчики, желающие использовать Poncho AI для своих e-commerce проектов, не могут импортировать готовый TUI
- Это ограничивает ценность библиотеки для сообщества

**Почему это важно:**
- **Для сообщества:** Go-разработчики смогут быстро запустить AI-агента с TUI для своих задач
- **Для проекта:** TUI становится частью публичного API, что повышает качество кода
- **Для вас:** Меньше поддержки «одноразовых» примеров — сообщество использует готовое

---

## Цель

Сделать TUI-компоненты доступными для сообщества разработчиков. Перенести Bubble Tea UI из `internal/ui/` в `pkg/tui/`, чтобы внешние пользователи могли импортировать и переиспользовать TUI-код.

### Зачем это нужно

Для open-source библиотеки AI-агентов:
- **Переиспользуемость** — сообщество может импортировать готовый TUI
- **Модульность** — можно создать другие UI (web, API) поверх того же ядра
- **Документация** — TUI будет видна в pkg.go.dev
- **Примеры** — готовый код для изучения паттернов

---

## Текущая архитектура (проблема)

```
poncho-ai/
├── pkg/                    # Библиотека (видима сообществу)
│   ├── agent/              ✅
│   ├── chain/              ✅
│   ├── tools/              ✅
│   └── ...                 ✅
│
├── internal/               # Скрыто от внешних пользователей
│   └── ui/
│       ├── model.go
│       ├── view.go
│       ├── update.go
│       └── ...
│
└── cmd/
    ├── poncho/main.go      ← импортирует internal/ui
    └── maxiponcho/main.go  ← импортирует internal/ui
```

**Проблема:** Внешние пользователи не могут использовать TUI-компоненты.

---

## Целевая архитектура

```
poncho-ai/
├── pkg/                    # Библиотека (полностью видна)
│   ├── agent/              # Высокоуровневый API
│   ├── chain/              # ReAct цикл
│   ├── tools/              # Инструменты
│   ├── tui/                # Bubble Tea UI (НОВОЕ)
│   │   ├── model.go
│   │   ├── view.go
│   │   ├── update.go
│   │   ├── styles.go
│   │   └── commands.go
│   ├── app/                # Утилиты
│   └── ...
│
├── internal/               # Можно удалить или оставить для совместимости
│   └── (удалить после миграции)
│
└── cmd/
    ├── poncho/main.go      ← обновить импорт на pkg/tui
    └── maxiponcho/main.go  ← обновить импорт на pkg/tui
```

---

## Стратегия рефакторинга

**Шаги:**
1. Создать `pkg/tui/` и скопировать файлы из `internal/ui/`
2. Обновить импорты в `pkg/tui/`
3. Обновить `cmd/` приложения
4. Удалить `internal/ui/` (опционально)

---

## Фаза 1: Создание `pkg/tui/`

**Цель:** Создать структуру и перенести код.

### Задачи

- [ ] **1.1** Создать директорию `pkg/tui/`

- [ ] **1.2** Скопировать файлы из `internal/ui/`
  ```
  cp internal/ui/model.go    pkg/tui/model.go
  cp internal/ui/view.go     pkg/tui/view.go
  cp internal/ui/update.go   pkg/tui/update.go
  cp internal/ui/styles.go   pkg/tui/styles.go
  ```

- [ ] **1.3** Обновить пакет и комментарии в каждом файле
  ```go
  // Было:
  package ui
  
  // Стало:
  package tui
  ```

- [ ] **1.4** Обновить импорты в `pkg/tui/` файлах
  - `"github.com/ilkoid/poncho-ai/internal/app"` → `"github.com/ilkoid/poncho-ai/pkg/app"`
  - `"github.com/ilkoid/poncho-ai/internal/ui"` → удалить или заменить

### Критерий завершения

Файлы созданы, компиляция проходит.

---

## Фаза 2: Обновление `cmd/` приложений

**Цель:** Обновить импорты на новый путь.

### Задачи

- [ ] **2.1** Обновить `cmd/poncho/main.go`
  ```go
  // Было:
  import "github.com/ilkoid/poncho-ai/internal/ui"
  
  // Стало:
  import "github.com/ilkoid/poncho-ai/pkg/tui"
  ```

- [ ] **2.2** Обновить `cmd/maxiponcho/main.go`
  - Аналогично poncho

- [ ] **2.3** Обновить другие `cmd/` если есть импорты internal/ui

### Критерий завершения

Все `cmd/` приложения компилируются с новыми импортами.

---

## Фаза 3: Валидация

**Цель:** Убедиться что всё работает.

### Задачи

- [ ] **3.1** Проверить компиляцию
  ```bash
  go build ./cmd/poncho
  go build ./cmd/maxiponcho
  go build ./cmd/chain-cli
  ```

- [ ] **3.2** Запустить TUI приложения
  ```bash
  ./poncho
  ./maxiponcho
  ```

- [ ] **3.3** Проверить что `pkg/tui` работает независимо

### Критерий завершения

Все приложения работают.

---

## Фаза 4: Cleanup (опционально)

**Цель:** Удалить старый код.

### Задачи

- [ ] **4.1** Удалить `internal/ui/`
  ```bash
  rm -rf internal/ui/
  ```

- [ ] **4.2** Проверить что нет импортов `internal/ui` в проекте
  ```bash
  grep -r "github.com/ilkoid/poncho-ai/internal/ui" . --include="*.go"
  ```

- [ ] **4.3** Обновить документацию (CLAUDE.md, brief.md)

---

## Файлы для изменения

### Создать:
- `pkg/tui/model.go` (копия из internal/)
- `pkg/tui/view.go` (копия из internal/)
- `pkg/tui/update.go` (копия из internal/)
- `pkg/tui/styles.go` (копия из internal/)

### Обновить:
- `cmd/poncho/main.go` (импорт)
- `cmd/maxiponcho/main.go` (импорт)

### Удалить (опционально):
- `internal/ui/model.go`
- `internal/ui/view.go`
- `internal/ui/update.go`
- `internal/ui/styles.go`

---

## Оценка трудозатрат

| Фаза | Время | Сложность |
|------|-------|-----------|
| Фаза 1 | 30 мин | Low |
| Фаза 2 | 15 мин | Low |
| Фаза 3 | 15 мин | Low |
| Фаза 4 | 15 мин | Low |
| **Итого** | **~1 час** | **Low** |

---

## Критерии успеха

1. ✅ `pkg/tui/` создан и виден внешним пользователям
2. ✅ Все `cmd/` приложения компилируются
3. ✅ TUI приложения работают
4. ✅ `internal/ui/` удалён или пуст
5. ✅ Библиотека готова к публикации

---

## Что получат пользователи

После рефакторинга пользователи смогут:

```go
import (
    "github.com/ilkoid/poncho-ai/pkg/tui"  // Готовый TUI
    "github.com/ilkoid/poncho-ai/pkg/agent" // Готовый агент
)

func main() {
    // Создать агента
    client, _ := agent.New(agent.Config{ConfigPath: "config.yaml"})
    
    // Запустить готовый TUI
    tui.Run(client)
}
```

---

## Rollback стратегия

Если что-то пошло не так:

```bash
# Откатить изменения
git checkout HEAD -- pkg/tui/
rm -rf pkg/tui/
# cmd/ уже используют internal/ui, всё работает
```

---

## Дополнительные улучшения (post-refactor)

После завершения основного рефакторинга:

1. **Добавить `pkg/tui.Run()` фасад** — простой запуск TUI в одну строку
2. **Создать примеры** в `examples/`
3. **Обновить README.md** — добавить секцию о TUI
4. **Добавить документацию** на pkg.go.dev
